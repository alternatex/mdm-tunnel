#!/usr/bin/env node

var net = require('net')
var MuxDemux = require('mux-demux')
var combine = require('stream-combiner')
var ms = require('msgpack-stream')
var httppp = require('httppp')
var program = require('commander')
var responseStream = require('response-stream')
var through = require('through')

program
.version(require('../package.json').version)
.option('-p, --port [port]', 'Port to listen for external connections on [port]', 8000)
.option('-c, --client-port [client]', 'Port to listen for client connections on [client]', 8001)
.option('-v, --verbose', 'verbose output')
.parse(process.argv)

if (program.verbose) process.env.DEBUG = '*'
var log = require('debug')('server')

var clients = {}

var appServer = net.createServer(function(socket) {
  log('new connection')
  var parser = httppp(function(info) {
    var host = (info[2].host && info[2].host.length) ? info[2].host[0] : null
    if (!host) {
      log('could not parse host', info[2]);
      socket.end()
      return
    }
    var hostname = host.split(":").shift() // remove port from host header
    var subdomain = hostname.split('.')
    var service = subdomain[0]
    var id = subdomain[1]
    if (subdomain.length === 3) {
      id = service
      service = false
    }
    var mx = clients[id]
    log('requesting service', service || '*')
    if (!mx) {
      log('client not connected', id)
      return socket.end()
    }
    if (!service) {
      parser.pipe(mx.createStream(
        'services'
      )).pipe(through(function(data) {
        var rs = responseStream(socket)
        rs.writeHead(200, {'Content-Type':'text/html'})
        rs.write(servicesList(data, host))
        rs.end()
      }))
      return
    }
    parser.pipe(mx.createStream({
      service: service
    })).pipe(socket);
  })
  socket.pipe(parser)
})

appServer.listen(program.port, function() {
  log('app server listening on', program.port)
})

var clientServer = net.createServer(function(sock) {
  log('client connected')
  var mx = MuxDemux({
    wrapper: function (stream) {
      return combine(ms.createDecodeStream(), stream, ms.createEncodeStream())
    }
  })

  // auth
  var id
  mx.on('connection', function(stream) {
    log('connection established')
    if (!stream.meta.auth) return
    var auth = stream.meta.auth
    log('client identified', auth.id)
    clients[auth.id] = mx
    id = auth.id
    stream.end()
  })
  sock.pipe(mx).pipe(sock)
  sock.on('end', function() {
    log('client disconnected', id)
    id && delete clients[id]
  })
})

clientServer.listen(program.clientPort, function() {
  log('client server listening on', program.clientPort)
})

function servicesList(data, host) {
  var a = [
'<!DOCTYPE html>',
'<html>',
  '<head>',
    '<title>Services</title>',
    '<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">',
  '</head>',
  '<body>',
  '<ul>'
  ].concat(data.split(',').map(function(item) {
    return '<li><a href="http://'+item + '.' + host+'">'+item+'</a></li>'
  })).concat([
  '</ul>',
  '</body>',
  '</html>'
  ]).join('\n')
  return a
}
